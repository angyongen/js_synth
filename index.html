<!DOCTYPE html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Javascript Synthesizer</title>
<script>
	var log = function(e) {alert(e)}
	window.onerror = function myErrorHandler(errorMsg, url, lineNumber) {
		log("Error in " + url + ": " + errorMsg + "\non line" + lineNumber);//or any message
		return false;
	}
</script>
<script src=".\settings.js"></script>
<script src=".\sounds.js"></script>
<script src=".\wav.js"></script>
<script src=".\script.js"></script>
<script src=".\html5_audio.js"></script>
<script src=".\web_audio_api.js"></script>
<style type="text/css">
	*{box-sizing: border-box; font-family: Calibri;}
	body{background-color: black; color: white;}
	form{font-size:19px}
	iframe, #log{width: 100%; height:8em;}
	input[type="checkbox"], input[type="radio"] {display:none/*width: 3em;	height: 3em;*/}
	input[type=radio]+div, input[type=checkbox]+div{
		display: inline-block;
		border: 1px solid white;
		padding: 0.1em 0.2em;
		margin: 0.1em 0.1em;
	}
	label>input[type=radio]:checked+div{
		background-color: #00a;
	}
	label>input[type=checkbox]:checked+div{
		background-color: #0a0;
	}
	input[type="range"]{width: 100%;	height: 2em;}
	.w,.b {position: relative; display: inline-block; border: 0.2em solid black;}
	.w { width:3em; height:11em; margin: 0 -0.1em 0 -0.1em;  background: white; z-index:0;}
	.b { width:2em; height:7em; margin: 0 -1em 4em -1em; background: black; z-index:1;}
	.settingsblock {display: inline-block; margin: 0 0.5em;}
	#input_vp {
		height: 14em; white-space: nowrap;
		overflow-x: scroll;
		overflow-y: hidden;
		margin: 0.5em 0;
	}
	textarea{background-color: black; color: white; margin: 0.5em 0;}
</style>
</head>
<body>
	<form name="form" style="height:100%">  
		<a href="/">back</a>
		<div class="settingsblock" onclick="updateSoundChoice()">
			<label><input type="radio" name="soundchoice" value="0"><div>Piano</div></label>
			<label><input type="radio" name="soundchoice" value="1"><div>Organ</div></label>
			<label><input type="radio" name="soundchoice" value="2" checked><div>Acoustic Guitar</div></label>
			<label><input type="radio" name="soundchoice" value="3"><div>EDM</div></label>
		</div>
		<div class="settingsblock" onclick="updateInputTypes()">
			<label><input type="checkbox" name="inputchoice_kb"><div>Keyboard</div></label>
			<label><input type="checkbox" name="inputchoice_vp" checked><div>Virtual Piano</div></label>
			<label><input type="checkbox" name="inputchoice_sm"><div>Score Maker</div></label>
		</div>
			<label><input type="checkbox" name="scrollLock"><div>Scroll Lock (Mobile)</div></label>
		<!--<div id="soundplayers"></div>-->
		<div>
			Notes Length = <span id="time_display"></span>
			<input type="range" min="1" max="10" value="5" class="slider" name="time" oninput="updateTimeChoice()">
			
		</div>

    <div id="input_kb">
    	Keyboard Offset = <span id="kb_offset_display"></span>
    	<input type="range" min="21" max="89" value="48" class="slider" name="kb_offset" oninput="document.getElementById('kb_offset_display').textContent = this.value">
    	<br>
	    Click here to open up the keyboard for mobile ->
			<textarea name="input"></textarea>
		</div>
		<div id="input_vp" style="font-size:12px;">
			<!--<input type="range" min="1" max="100" value="50" class="slider" id="vp_scale">-->
			<br>
<div id="keys"><div class="w"></div><div class="b"></div><div class="w"></div><!--1--><div class="w"></div><div class="b"></div><div class="w"></div><div class="b"></div><div class="w"></div><div class="w"></div><div class="b"></div><div class="w"></div><div class="b"></div><div class="w"></div><div class="b"></div><div class="w"></div><!--2--><div class="w"></div><div class="b"></div><div class="w"></div><div class="b"></div><div class="w"></div><div class="w"></div><div class="b"></div><div class="w"></div><div class="b"></div><div class="w"></div><div class="b"></div><div class="w"></div><!--3--><div class="w"></div><div class="b"></div><div class="w"></div><div class="b"></div><div class="w"></div><div class="w"></div><div class="b"></div><div class="w"></div><div class="b"></div><div class="w"></div><div class="b"></div><div class="w"></div><!--4--><div class="w"></div><div class="b"></div><div class="w"></div><div class="b"></div><div class="w"></div><div class="w"></div><div class="b"></div><div class="w"></div><div class="b"></div><div class="w"></div><div class="b"></div><div class="w"></div><!--5--><div class="w"></div><div class="b"></div><div class="w"></div><div class="b"></div><div class="w"></div><div class="w"></div><div class="b"></div><div class="w"></div><div class="b"></div><div class="w"></div><div class="b"></div><div class="w"></div><!--6--><div class="w"></div><div class="b"></div><div class="w"></div><div class="b"></div><div class="w"></div><div class="w"></div><div class="b"></div><div class="w"></div><div class="b"></div><div class="w"></div><div class="b"></div><div class="w"></div><!--7--><div class="w"></div><div class="b"></div><div class="w"></div><div class="b"></div><div class="w"></div><div class="w"></div><div class="b"></div><div class="w"></div><div class="b"></div><div class="w"></div><div class="b"></div><div class="w"></div><!--8--><div class=w></div></div>
		</div>
    <iframe id="input_sm" src="..\js_scoremaker\index.html"></iframe>
    <textarea hidden readonly name="log"></textarea><br>
		<sub>Inspired by <a href="https://keithwhor.com/music/">https://keithwhor.com/music/</a></sub>
		<label><input type="checkbox" onclick="document.form.log.hidden = !this.checked"><div>Debug Log</div></label>
	</form>
	<script>
		initialiseVariables()
		document.getElementById('kb_offset_display').textContent = document.form.kb_offset.value
		document.getElementById('time_display').textContent = document.form.time.value
		function updateInputTypes() {
			document.getElementById("input_kb").style.display = document.form.inputchoice_kb.checked?"":"none"
			document.getElementById("input_vp").style.display = document.form.inputchoice_vp.checked?"":"none"
			document.getElementById("input_sm").style.display = document.form.inputchoice_sm.checked?"":"none"
		}
		updateInputTypes();
		function updateSoundChoice() {
			soundchoice = parseInt(document.form.soundchoice.value)
		}
		updateSoundChoice();
		updateTimeChoice();

		document.form.log.value = ""
		document.form.input.oninput = function(e) {
			var keyId = 'AWSEDFTGYHJIKL'.indexOf(this.value[this.value.length - 1].toUpperCase())
			this.value='';
			var midinote = parseInt(document.form.kb_offset.value) + keyId
			noteDown(midinote)
		}
		document.body.onkeydown = function (event) {
			event.preventDefault();
			if (document.form.inputchoice_kb.checked) {
				var keyId = keyCodeMapping.indexOf(event.keyCode)
				if (keyId != -1) {
					var midinote = parseInt(document.form.kb_offset.value) + keyId
					noteDown(midinote)
				}
			}
		}
		document.body.onkeyup = function (event) {
			if (document.form.inputchoice_kb.checked) {
				var keyId = keyCodeMapping.indexOf(event.keyCode)
				if (keyId != -1) {
					var midinote = parseInt(document.form.kb_offset.value) + keyId
					noteUp(midinote)
				}
			}
		}
		var keys = document.getElementById("keys").children
		for (var keyId = 0; keyId < keys.length; keyId++) {
			keys[keyId].id = keyId;
			keys[keyId].ondragstart = function() {return false;}
			keys[keyId].onclick = function(e) {noteDown(parseInt(this.id)+21)}
			keys[keyId].onmouseenter = function(e) {
				if(e.buttons == 1) {
					noteDown(parseInt(this.id)+21)
				}
			}
			keys[keyId].ontouchstart = function(e) {
				if (document.form.scrollLock.checked) {
					e.preventDefault();
					noteDown(parseInt(this.id)+21)
				} else {
				}
			};
			keys[keyId].ontouchmove = function(e) {
				var touchedElement = document.elementFromPoint(e.touches[0].clientX, e.touches[0].clientY);
				if (document.form.scrollLock.checked) {
					if (lastTouchElement != touchedElement) {
						if (touchedElement && touchedElement.id) noteDown(parseInt(touchedElement.id)+21)
					}
				}
				lastTouchElement = touchedElement
			}
		}
	</script>
</body>
