<script type="text/javascript">
	var noteRepeats = 3 //the number of duplicate note audio stored
	var appendToDocument = false //whether or not note audio is appended to the soundplayers div
	var keyCode_Sequential_Mapping = [81, 50, 87, 51, 69, 82, 53, 84, 54, 89, 55, 85, 73, 57, 79, 48, 80, 219, 187, 221]
	var sustain = true

	function log(x) {
		var element = document.createElement("pre")
		//element.innerHTML = x;
		document.form.log.value += (x+ '\n')
		document.form.log.scrollTop = document.form.log.scrollHeight
	}

	function encodeWAVBlob(Channels, SampleRate, BitsPerSample, data) {
		var t0 = performance.now();
		//var enc = new TextEncoder();

		var uint16_bytes = function(v) {
			var PACKED = new Uint8Array(2);
			new DataView(PACKED.buffer).setUint16(0, v, true/*all values are little endian*/);
			return PACKED;
		}
		var uint32_bytes = function(v) {
			var PACKED = new Uint8Array(4);
			new DataView(PACKED.buffer).setUint32(0, v, true/*all values are little endian*/);
			return PACKED;
		}
		//var ChunkID = enc.encode("RIFF")
		//var ChunkFormat = enc.encode("WAVE")
		//var SubChunk1ID = enc.encode("fmt ")
		var SubChunk1Size = 16
		var AudioFormat = 1 // Values other than 1 indicate compression.
		var ByteRate = SampleRate * Channels * BitsPerSample / 8 //bytes per second
		var BlockAlign = Channels * BitsPerSample / 8  //#bytes for 1 sample, all channels
		//var SubChunk2ID = enc.encode("data")
		var SubChunk2Size =  data.length
		var ChunkSize = 36 + SubChunk2Size

		var blob = new Blob([
			"RIFF",//ChunkID,
			uint32_bytes(ChunkSize),
			"WAVE",//ChunkFormat,
			"fmt ",//SubChunk1ID,
			uint32_bytes(SubChunk1Size),
			uint16_bytes(AudioFormat),
			uint16_bytes(Channels),
			uint32_bytes(SampleRate),
			uint32_bytes(ByteRate),
			uint16_bytes(BlockAlign),
			uint16_bytes(BitsPerSample),
			"data",//SubChunk2ID,
			uint32_bytes(SubChunk2Size),
			data
		], {type: 'audio/wav'})

		var t1 = performance.now();
		var time = (t1 - t0)
		if (time < min1) min1 = time
		if (time > max1) max1 = time
		//log("t1:"+ time +", avg:" + (totalTime1 += time)/(++totalTimes1) + ", min" + min1 + ", max" + max1);

		return blob//
	}

	var modulations = [
		function(i, sampleRate, frequency, x) { return 1 * Math.sin(2 * Math.PI * ((i / sampleRate) * frequency) + x); },
		function(i, sampleRate, frequency, x) { return 1 * Math.sin(4 * Math.PI * ((i / sampleRate) * frequency) + x); },
		function(i, sampleRate, frequency, x) { return 1 * Math.sin(8 * Math.PI * ((i / sampleRate) * frequency) + x); },
		function(i, sampleRate, frequency, x) { return 1 * Math.sin(0.5 * Math.PI * ((i / sampleRate) * frequency) + x); },
		function(i, sampleRate, frequency, x) { return 1 * Math.sin(0.25 * Math.PI * ((i / sampleRate) * frequency) + x); },
		function(i, sampleRate, frequency, x) { return 0.5 * Math.sin(2 * Math.PI * ((i / sampleRate) * frequency) + x); },
		function(i, sampleRate, frequency, x) { return 0.5 * Math.sin(4 * Math.PI * ((i / sampleRate) * frequency) + x); },
		function(i, sampleRate, frequency, x) { return 0.5 * Math.sin(8 * Math.PI * ((i / sampleRate) * frequency) + x); },
		function(i, sampleRate, frequency, x) { return 0.5 * Math.sin(0.5 * Math.PI * ((i / sampleRate) * frequency) + x); },
		function(i, sampleRate, frequency, x) { return 0.5 * Math.sin(0.25 * Math.PI * ((i / sampleRate) * frequency) + x); }
	]
	var totalTime1 = 0
	var totalTimes1 = 0
	var min1 = 99999
	var max1 = 0

	var totalTime2 = 0
	var totalTimes2 = 0
	var min2 = 99999
	var max2 = 0
	function piano_wave(i, sampleRate, frequency)
	{
		//var base = modulations[0];
		return modulations[1](
					i,
					sampleRate,
					frequency,
					Math.pow(modulations[0](i, sampleRate, frequency, 0), 2) + (0.75 * modulations[0](i, sampleRate, frequency, 0.25)) + (0.1 * modulations[0](i, sampleRate, frequency, 0.5))
					)
	}
	function piano_16(data, sampleRate, frequency, volume, time, decayEnd)
	{
		var i = 0;
		var j = 0;
		var attack = 0.002; 
		var dampen = Math.pow(0.5*Math.log((frequency*volume)/sampleRate),2)

		var attackLen_int = (sampleRate * attack) | 0;
		var attackLen = (sampleRate*attack)
		var decayLen = (sampleRate*(time-attack))
		while(i < attackLen_int) {
			val = volume * (i/attackLen) * piano_wave(i, sampleRate, frequency)
			data[j++] = val;
			data[j++] = val >> 8;
			++i;
		}
		while (i < decayEnd) {
			val = volume * Math.pow((1-((i-attackLen)/decayLen)),dampen) * piano_wave(i, sampleRate, frequency)
			data[j++] = val;
			data[j++] = val >> 8;
			++i;
		}
	}
	function organ_wave(i, sampleRate, frequency)
	{
		var base = modulations[0];
		return modulations[1](
					i,
					sampleRate,
					frequency,
					base(i, sampleRate, frequency, 0) + 0.5*base(i, sampleRate, frequency, 0.25) + 0.25*base(i, sampleRate, frequency, 0.5)
				);
	}
	function organ_16(data, sampleRate, frequency, volume, time, decayEnd)
	{
		var i = 0;
		var j = 0;
			var attack = 0.3
			var dampen = 1+(frequency * 0.01);

			var attackLen_int = (sampleRate * attack) | 0;
			var attackLen = (sampleRate*attack)
			var decayLen = (sampleRate*(time-attack))
			while(i < attackLen_int) {
				val = volume * (i/attackLen) * organ_wave();

				data[j++] = val;
				data[j++] = val >> 8;
				++i;
			}

			while (i < decayEnd) {
				val = volume * Math.pow((1-((i-attackLen)/decayLen)),dampen) * organ_wave();

				data[j++] = val;
				data[j++] = val >> 8;
				++i;
			}
	}
	function acoustic_16(data, period, samples, volume)
	{
		var i = 0;
		var j = 0;
		//var data = new Uint8Array(samples * 2); //16 bit integer
		var valueTable = new Array(period)
		for(i = 0; i < period; i++) {
			var value = volume * (valueTable[i] = (Math.random() > 0.5) ? 1 : -1)
			data[j++] = value
			data[j++] = value >> 8
		}
		for(; i < samples; i++) {
			var point = i % period
			var next = point + 1;
			if (next == period) {next = 0}
			var value = volume * (valueTable[point] = (valueTable[point] + valueTable[next]) / 2)
			data[j++] = value
			data[j++] = value >> 8
		}
		//return data;
	}
	function edm_16(data, sampleRate, frequency, volume, time, decayEnd)
	{
		var i = 0;
		var j = 0;
		var attack = 0.002
		var dampen = 1
		var attackLen_int = (sampleRate * attack) | 0;
		var attackLen = (sampleRate*attack)
		var decayLen = (sampleRate*(time-attack))
		var wave = function() {
			var base = modulations[0];
			var mod = modulations.slice(0);
			return mod[0](
				i,
				sampleRate,
				frequency,
				mod[9](
					i,
					sampleRate,
					frequency,
					mod[2](
						i,
						sampleRate,
						frequency,
						Math.pow(base(i, sampleRate, frequency, 0), 3) +
							Math.pow(base(i, sampleRate, frequency, 0.5), 5) +
							Math.pow(base(i, sampleRate, frequency, 1), 7)
					)
				) +
					mod[8](
						i,
						sampleRate,
						frequency,
						base(i, sampleRate, frequency, 1.75)
					)
			);
		}
		while(i < attackLen_int) {
			val = volume * (i/attackLen) * wave();

			data[j++] = val;
			data[j++] = val >> 8;
			++i;
		}

		while (i < decayEnd) {
			val = volume * Math.pow((1-((i-attackLen)/decayLen)),dampen) * wave();

			data[j++] = val;
			data[j++] = val >> 8;
			++i;
		}
	}
	function generateWAV(sound, sampleRate, time, frequency, volume)
	{
		var decayEnd = (sampleRate * time) | 0;
		var data = new Uint8Array(new ArrayBuffer(decayEnd * 2));

		var t0 = performance.now();
		switch(sound)
		{
			case 0: //piano
			piano_16(data, sampleRate, frequency, volume, time, decayEnd)
			break;
			case 1: //organ
			organ_16(data, sampleRate, frequency, volume, time, decayEnd)
			break;
			case 2: //acoustic
			var period = Math.floor(sampleRate/frequency)
			acoustic_16(data, period, decayEnd, volume)
			break;
			case 3: //edm
			edm_16(data, sampleRate, frequency, volume, time, decayEnd)
			break;
		}

	/*
		while(i < attackLen_int) {
			val = volume * (i/attackLen) * waveFunc(waveBind, i, sampleRate, frequency, volume);

			data[j++] = val;
			data[j++] = val >> 8;
			++i;
		}

		while (i < decayEnd) {
			val = volume * Math.pow((1-((i-attackLen)/decayLen)),dampen) * waveFunc(waveBind, i, sampleRate, frequency, volume);

			data[j++] = val;
			data[j++] = val >> 8;
			++i;
		}
		*/
		var t1 = performance.now();
		var time = (t1 - t0)
		if (time < min2) min2 = time
		if (time > max2) max2 = time
		log("t2:"+ time +", avg:" + (totalTime2 += time)/(++totalTimes2) + ", min" + min2 + ", max" + max2);
		return encodeWAVBlob(1, sampleRate, 16, data)
	}
	function createSoundPlayer(sound, sampleRate, time, frequency, volume) {
		var src = URL.createObjectURL(generateWAV(sound, sampleRate, time, frequency, volume))
		var soundplayer = new Audio(src);
		soundplayer.setAttribute('type', 'audio/wav');
		soundplayer.autoplay = false;
		if (appendToDocument) {
			soundplayer.controls = true;
			document.getElementById("soundplayers").appendChild(soundplayer)
		}
		soundplayer.onloadeddata = function(e) { e.target.play(); };
		//soundplayer.onended = function() {soundplayer = null; URL.revokeObjectURL(src)}
		//soundplayer.load();
		return soundplayer;
	}
	var soundplayersstorages = [[], [], [], []]
	var keyDown = function(event) {
		var soundchoice = parseInt(document.form.soundchoice.value);
		var soundplayersstorage = soundplayersstorages[soundchoice]
		var keyId = keyCode_Sequential_Mapping.indexOf(event.keyCode)
		if (keyId != -1) {
			var midinote = 70 + keyId
			var frequency = 440 * Math.pow(2, ( (midinote - 69) / 12) )
			var soundplayer;
			var soundplayers;
			if (!(midinote < soundplayersstorage.length)) soundplayersstorage[midinote] = []
			if (!soundplayersstorage[midinote]) soundplayersstorage[midinote] = []
			soundplayers = soundplayersstorage[midinote]
			var maxTime = -1;
			var maxTime_soundplayer;
			for (var i = 0; i < soundplayers.length; i++)
			{
				soundplayer = soundplayersstorage[midinote][i]
				if (soundplayer.currentTime > maxTime) {
					maxTime_soundplayer = soundplayer;
					maxTime = soundplayer.currentTime;
					if (soundplayer.currentTime == soundplayer.duration) break;
				}
			}
			soundplayer = maxTime_soundplayer
			//++i;
			if (!soundplayer || (!soundplayersstorage[midinote][i] && (i < noteRepeats))) {
				soundplayer = createSoundPlayer(soundchoice, 44100, 5, frequency, 16384)
				soundplayersstorage[midinote].push(soundplayer)
			} else {
			}
			if (soundplayer.currentTime == soundplayer.duration || soundplayer.currentTime == 0) {
				//soundplayer.play();
				soundplayer.load();
			} else {
				soundplayer.currentTime = 0;
			}
		}
	}
</script>

<body>
	<div id="soundplayers"></div>
	<form name="form" style="height:100%">  
    <textarea name="log" style="width:100%; height:50%"></textarea>
    <input type="radio" name="soundchoice" value="0" checked=true>Piano
    <input type="radio" name="soundchoice" value="1">Organ
    <input type="radio" name="soundchoice" value="2">Acoustic Guitar
    <input type="radio" name="soundchoice" value="3">EDM
    <br>
		<textarea name="input" oninput="this.value=''"></textarea>
	</form>
	<script>
		document.body.onkeydown = keyDown
		document.form.log.value = ""
	</script>
</body>
